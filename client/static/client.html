<!DOCTYPE html>
<html class="light" lang="th">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πÅ‡∏Å‡∏ô‡∏û‡∏±‡∏™‡∏î‡∏∏ NU</title>

  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai+Looped:wght@100..900&display=swap"
    rel="stylesheet">


  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: { primary: "#f95f06" },
          fontFamily: {
            display: ["Noto Sans Thai Looped", "sans-serif"]
          }
        }
      }
    }
  </script>


  <style>
    body {
      font-family: Inter
    }

    .scan-zone {
      border: 2px dashed #e9d8ce
    }

    .latest {
      background: #fff6e5
    }
  </style>
</head>

<body class="bg-background-light min-h-screen flex flex-col font-display">


  <header class="sticky top-0 bg-white/80 backdrop-blur border-b p-4 z-40">
    <div class="max-w-xl mx-auto flex justify-between items-center">

      <!-- LEFT -->
      <div class="flex gap-3 items-center">
        <img src="/static/NUDPACK_LOGO2.png" class="w-10 h-10 object-contain" />

        <div>
          <h2 class="font-bold">NUDPACK</h2>

          <p class="text-[10px] text-orange-400">
            Naresuan University Dormitory Parcel System
          </p>
          <div class="mt-2 inline-flex items-center rounded-xl bg-white/80 backdrop-blur
shadow px-2 py-1 text-[10px]">

            <span class="material-symbols-outlined text-[12px] text-gray-400 mr-1">badge</span>

            <span id="staffLabel" class="font-medium text-gray-700"></span>

            <span class="mx-1 text-gray-300">‚Ä¢</span>

            <span id="carrierLabel" class="text-orange-400"></span>

          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <button onclick="logout()" class="flex items-center gap-1 px-3 py-1.5 rounded-lg
bg-red-50 text-red-600 text-xs font-semibold
hover:bg-red-100 active:scale-95 transition">

        <span class="material-symbols-outlined text-sm">
          logout
        </span>
      </button>

    </div>
  </header>

  <main class="flex-1 max-w-xl mx-auto w-full pb-40">


    <section class="p-4 mt-4">
      <div class="bg-white rounded-xl p-4 scan-zone shadow-sm">

        <!-- üîπ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏û‡∏±‡∏™‡∏î‡∏∏ -->
        <label class="text-sm font-semibold text-orange-400">
          ‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏û‡∏±‡∏™‡∏î‡∏∏
        </label>

        <div class="flex items-center gap-2 mt-2">
          <input id="parcelAmount" type="number" min="1"
            class="flex-1 border rounded-lg h-12 w-10 focus:outline-none focus:ring-2 focus:ring-primary/50"
            placeholder="‡πÄ‡∏ä‡πà‡∏ô 50" />
          <button onclick="loadAvailableSections()" class="bg-primary text-white px-4 h-12 rounded-lg">
            ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Section
          </button>
        </div>
        <div id="sectionGrid" class="grid grid-cols-3 gap-2 mt-4">



        </div>
        <button id="confirmReserveBtn" onclick="confirmReservation()"
          class="mt-4 w-full bg-primary text-white py-2 rounded-lg hidden">
          ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
        </button>




        <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡∏¥‡∏ß -->


        <div class="border-t my-5"></div>

        <!-- üîí ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏ -->
        <div class="flex flex-col gap-1 mb-2">
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" id="unofficialCheck"
              class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary">
            <span class="text-sm text-gray-700">‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏•‡πà‡∏≠‡∏á</span>
          </label>

          <input id="unofficialName" type="text"
            class="hidden w-full border rounded-lg h-10 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 mt-1"
            placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö (‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏•‡πà‡∏≠‡∏á)" />
        </div>

        <label class="text-sm font-semibold text-orange-400">
          ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏
        </label>

        <div class="flex mt-2">
          <input id="scanInput" disabled class="flex-1 border rounded-l-lg h-12 px-3 bg-gray-100"
            placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏" />

          <button id="scanBtn" disabled onclick="handleScan(scanInput.value.trim())"
            class="bg-gray-400 text-white px-4 rounded-r-lg flex items-center">
            <span class="material-symbols-outlined text-xl">send</span>
          </button>
        </div>

        <!-- üîí ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á -->
        <div class="flex gap-3 mt-4">
          <button id="cameraOnBtn" disabled onclick="startCamera()"
            class="flex-1 bg-gray-400 text-white rounded-lg h-12 flex justify-center items-center gap-2">
            <span class="material-symbols-outlined">photo_camera</span>
            ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
          </button>

          <button id="cameraOffBtn" disabled onclick="stopCamera()"
            class="flex-1 bg-gray-300 text-gray-500 rounded-lg h-12 flex justify-center items-center gap-2">
            <span class="material-symbols-outlined">videocam_off</span>
            ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
          </button>
        </div>

        <div id="messages" class="text-sm mt-3"></div>

      </div>
    </section>

    <section class="px-4 mt-6">

      <div class="flex justify-between mb-3">
        <div>
          <h3 class="font-bold">‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå</h3>
          <p class="text-sm text-orange-400">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</p>
        </div>

        <span id="previewBadge" class="bg-primary/10 text-primary text-xs px-3 py-1 rounded-full">0 ‡∏ä‡∏¥‡πâ‡∏ô</span>
      </div>

      <div id="previewBody" class="flex flex-col gap-3"></div>

    </section>

  </main>

  <footer class="fixed bottom-0 left-0 right-0 bg-white border-t p-4">
    <div class="max-w-xl mx-auto">

      <div class="flex justify-between text-sm mb-3">
        <span>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <strong id="previewCount">0</strong></span>
      </div>

      <button id="confirmAllBtn" onclick="confirmAllCheck()" disabled
        class="w-full bg-primary text-white py-4 rounded-xl font-bold disabled:opacity-50">
        ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      </button>

    </div>
  </footer>
  <div id="queuePopup" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">

    <div class="bg-white rounded-2xl p-8 w-80 text-center shadow-xl">

      <p class="text-sm text-gray-400 mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏¥‡∏ß</p>

      <div id="popupQueue" class="text-7xl font-bold text-primary mb-3">-</div>

      <p id="popupTracking" class="text-sm text-gray-500 mb-6"></p>

      <button onclick="closePopup()" class="w-full bg-primary text-white py-3 rounded-xl font-bold">
        ‡∏ï‡∏Å‡∏•‡∏á
      </button>

    </div>
  </div>
  <div id="cameraOverlay" class="fixed inset-0 bg-black/70 hidden z-50 flex items-center justify-center">

    <div class="bg-white rounded-2xl p-4 w-80 shadow-xl">

      <div class="text-sm font-semibold mb-2 text-center text-gray-700">
        ‡∏™‡πÅ‡∏Å‡∏ô QR code
      </div>

      <div id="reader" class="rounded-lg overflow-hidden"></div>

      <button onclick="stopCamera()" class="mt-4 w-full bg-orange-500 text-white py-2 rounded-xl font-semibold">
        ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
      </button>

    </div>

  </div>
  <!-- Global Alert Popup -->
  <div id="alertPopup" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">

    <div id="alertBox"
      class="bg-white w-80 rounded-2xl shadow-xl p-6 text-center scale-95 opacity-0 transition duration-200">

      <div id="alertIcon"
        class="mx-auto mb-3 w-14 h-14 flex items-center justify-center rounded-full text-white text-2xl">
      </div>

      <h2 id="alertTitle" class="text-lg font-bold mb-2"></h2>

      <p id="alertMessage" class="text-sm text-gray-600 mb-5"></p>

      <button onclick="closeAlert()" class="w-full py-2 rounded-xl font-semibold text-white bg-primary">
        ‡∏ï‡∏Å‡∏•‡∏á
      </button>

    </div>
  </div>
  <!-- Confirm Upload Popup -->
  <div id="confirmPopup" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">

    <div class="bg-white rounded-2xl p-6 w-[350px] text-center shadow-xl">

      <div class="mx-auto mb-3 w-14 h-14 flex items-center justify-center
                rounded-full text-white text-2xl bg-red-500">
        !
      </div>

      <h3 id="confirmTitle" class="text-lg font-bold mb-2">
  ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
</h3>

      <p id="confirmMessage" class="text-gray-600 whitespace-pre-line"></p>

      <div class="flex gap-3 mt-5">

        <button onclick="closeConfirm()" class="flex-1 py-2 rounded-xl font-semibold
                     bg-gray-200 text-gray-700">
          ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
        </button>

        <button onclick="confirmAll()" class="flex-1 py-2 rounded-xl font-semibold
                     text-white bg-red-500">
          ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
        </button>

      </div>
    </div>
  </div>


  <script>
    const SERVER = location.origin

    const scanInput = document.getElementById("scanInput")
    const previewBody = document.getElementById("previewBody")
    const previewCount = document.getElementById("previewCount")
    const previewBadge = document.getElementById("previewBadge")
    const confirmAllBtn = document.getElementById("confirmAllBtn")
    const messages = document.getElementById("messages")

    let preview = JSON.parse(localStorage.getItem("preview") || "[]")
    let reserveLocked = false
    let showLimit = 600


    preview = preview.map(p => ({
      ...p,
      created_at: p.created_at || new Date().toISOString()
    }))

    let qrScanner = null
    let busy = false
    let scanningLocked = false

    scanInput.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        handleScan(scanInput.value.trim())
        scanInput.value = ""
      }
    })

    const unofficialCheck = document.getElementById("unofficialCheck")
    const unofficialName = document.getElementById("unofficialName")

    unofficialCheck.addEventListener("change", (e) => {
      if (e.target.checked) {
        unofficialName.classList.remove("hidden")
        unofficialName.focus()
      } else {
        unofficialName.classList.add("hidden")
        unofficialName.value = ""
      }
    })

    function beep(ok = true) {
      const c = new AudioContext()
      const o = c.createOscillator()
      o.connect(c.destination)
      o.frequency.value = ok ? 880 : 200
      o.start(); o.stop(c.currentTime + .12)
    }
    let mainScanner = null
    let cameraLocked = false

    function startCamera() {
      if (mainScanner) return

      document.getElementById("cameraOverlay").classList.remove("hidden")
      cameraLocked = false

      mainScanner = new Html5Qrcode("reader")

      Html5Qrcode.getCameras().then(cams => {
        if (!cams.length) {
          alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á")
          stopCamera()
          return
        }

        // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
        const backCam = cams.find(c =>
          c.label.toLowerCase().includes("back") ||
          c.label.toLowerCase().includes("rear")
        )

        const camId = backCam ? backCam.id : cams[cams.length - 1].id

        mainScanner.start(
          camId,
          { fps: 10, qrbox: 220 },
          txt => {
            if (cameraLocked) return
            cameraLocked = true

            handleScan(txt.trim())
            setTimeout(stopCamera, 400)
          }
        )
      }).catch(e => {
        alert(e)
        stopCamera()
      })
    }

    function stopCamera() {
      if (!mainScanner) {
        document.getElementById("cameraOverlay").classList.add("hidden")
        return
      }

      mainScanner.stop().then(() => {
        mainScanner.clear()
        mainScanner = null
        cameraLocked = false
        document.getElementById("cameraOverlay").classList.add("hidden")
      })
    }

    async function handleScan(tracking) {

      if (!tracking || busy) return

      if (!selectedSections.length) {
        showAlert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏à‡∏≠‡∏á Section ‡∏Å‡πà‡∏≠‡∏ô")
        return
      }

      busy = true

      try {
        const unofficialVal = unofficialCheck.checked ? unofficialName.value.trim() : null

        const r = await fetch(`${SERVER}/api/parcels`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            tracking_number: tracking,
            provisional: true,
            section_id: selectedSections[0],  //  ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å
            unofficial_recipient: unofficialVal // üëà ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏õ
          })
        })


        if (!r.ok) {
          const err = await r.json()
          flash(err.detail || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", false)
          busy = false
          return
        }

        const data = await r.json()

        // üî• ‡πÉ‡∏ä‡πâ queue ‡∏à‡∏≤‡∏Å backend
        addPreview(tracking, data.queue_number, data.status, selectedSections[0])

        // ‚úÖ Reset unofficial inputs
        unofficialCheck.checked = false
        unofficialName.value = ""
        unofficialName.classList.add("hidden")

        // ‚úÖ Reset scan input
        scanInput.value = ""


        beep()

      } catch (e) {
        flash("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", false)
      }

      busy = false
    }


    function addPreview(t, q, s, sectionId) {
      preview.unshift({
        tracking: t,
        queue: q,
        status: s,
        section_id: sectionId,   // üëà ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        created_at: new Date().toISOString()
      })

      save()
      render()
      showPopup(q, t)
    }



    function render() {
      previewBody.innerHTML = ""

      preview.forEach((p, i) => {

        previewBody.innerHTML += `
<div class="flex justify-between items-center p-4 bg-white rounded-xl ${i == 0 ? "latest" : ""}">
<div class="flex gap-4">
<div class="size-10 rounded-full border flex items-center justify-center font-bold">
${p.queue ?? "-"}
</div>

<div>
<p class="font-bold">${p.tracking}</p>

<div class="flex items-center gap-2 mt-1">
<span class="text-xs bg-orange-100 px-2 rounded">${p.status}</span>

${p.created_at ? `
<span class="text-xs bg-green-100 text-green-700 px-2 rounded">
${new Date(p.created_at).toLocaleString("th-TH", { timeZone: "Asia/Bangkok" })}
</span>` : ``}



</div>
</div>
</div>

<button onclick="removeAt(${i})" class="text-red-500">
<span class="material-symbols-outlined">delete</span>
</button>

</div>`
      })

      previewCount.innerText = preview.length
      previewBadge.innerText = preview.length + " ‡∏ä‡∏¥‡πâ‡∏ô"
      confirmAllBtn.disabled = !preview.length
    }


    async function removeAt(i) {
      const p = preview[i]
      await fetch(`${SERVER}/api/parcels/${p.tracking}`, { method: "DELETE" })
      preview.splice(i, 1); save(); render()
    }

    async function confirmAll() {
      for (const p of preview) {
        await fetch(`${SERVER}/api/parcels/${p.tracking}/confirm_pending`, { method: "POST" })
      }
      preview = []; save(); render()
      flash("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß", true)
      localStorage.removeItem("parcelAmount")
      localStorage.removeItem("selectedSections")
      localStorage.removeItem("reserveLocked")
      localStorage.removeItem("preview")

      location.reload()


    }

    function save() { localStorage.setItem("preview", JSON.stringify(preview)) }

    function flash(t, ok = true) {
      messages.innerHTML = (ok ? "‚úî " : "‚úñ ") + t
      messages.className = ok ? "text-green-600" : "text-red-500"
      setTimeout(() => messages.innerHTML = "", 3000)
    }

    render()
    const queuePopup = document.getElementById("queuePopup")
    const popupQueue = document.getElementById("popupQueue")
    const popupTracking = document.getElementById("popupTracking")

    function showPopup(queue, tracking) {
      popupQueue.innerText = queue || "-"
      popupTracking.innerText = tracking
      queuePopup.classList.remove("hidden")
      queuePopup.classList.add("flex")
    }

    function closePopup() {
      queuePopup.classList.add("hidden")
      queuePopup.classList.remove("flex")
    }

    async function logout() {

      try {

        const savedSections = localStorage.getItem("selectedSections")

        if (savedSections) {

          const sectionIds = JSON.parse(savedSections)

          if (sectionIds.length > 0) {
            await fetch(`${SERVER}/api/queue/cancel`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                section_ids: sectionIds
              })
            })
          }
        }

      } catch (e) {
        console.error("cancel error", e)
      }

      // üî• ‡∏•‡πâ‡∏≤‡∏á localStorage
      localStorage.removeItem("parcelAmount")
      localStorage.removeItem("selectedSections")
      localStorage.removeItem("reserveLocked")
      localStorage.removeItem("preview")

      // üî• logout session server
      fetch("/logout", {
        credentials: "include"
      }).finally(() => {
        location.replace("/login_client")
      })
    }

    const staffLabel = document.getElementById("staffLabel")
    const carrierLabel = document.getElementById("carrierLabel")

    staffLabel.innerText = localStorage.getItem("staff_name") || "-"
    carrierLabel.innerText = localStorage.getItem("carrier_name") || "-"

    function confirmParcelAmount() {
      const amount = document.getElementById("parcelAmount").value;

      if (!amount || amount <= 0) {
        showAlert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
        return;
      }

      alert("‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢: " + amount);
    }



    async function loadAvailableSections() {

      const amount = parseInt(document.getElementById("parcelAmount").value)

      if (!amount || amount <= 0) {
        showAlert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏û‡∏±‡∏™‡∏î‡∏∏")
        return
      }

      // üî• ‡∏´‡πâ‡∏≤‡∏°‡∏•‡πâ‡∏≤‡∏á selectedSections ‡∏ñ‡πâ‡∏≤‡πÄ‡∏£‡∏≤‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
      if (!reserveLocked) {
        selectedSections = []
      }

      // üî• ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á amount ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
      const res = await fetch(`${SERVER}/api/queue/sections_available?amount=${amount}`)

      const sections = await res.json()

      const grid = document.getElementById("sectionGrid")
      grid.innerHTML = ""

      if (!sections.length) {
        grid.innerHTML = `
      <div class="text-red-500 text-sm">
        ‡πÑ‡∏°‡πà‡∏°‡∏µ section ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏µ‡πâ
      </div>`
        return
      }

      availableSections = sections
      renderSections()
    }


    let selectedSections = []
    let requiredAmount = 0
    let availableSections = []

    async function confirmReservation() {

      if (!selectedSections.length) {
        showAlert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Section ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏≠‡∏±‡∏ô")
        return
      }

      try {

        const r = await fetch(`${SERVER}/api/queue/reserve`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            section_ids: selectedSections
          })
        })

        if (!r.ok) {
          const err = await r.json()
          showAlert(err.detail || "‡∏à‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")
          return
        }

        showAlert("‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß", "success", "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")

        reserveLocked = true
        // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å state ‡∏•‡∏á localStorage
        localStorage.setItem("parcelAmount", document.getElementById("parcelAmount").value)
        localStorage.setItem("selectedSections", JSON.stringify(selectedSections))
        localStorage.setItem("reserveLocked", "true")


        // üî• reload sections ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏ó‡∏≤
        await loadAvailableSections()

        // üîì ‡πÄ‡∏õ‡∏¥‡∏î scan
        const input = document.getElementById("scanInput")
        const scanBtn = document.getElementById("scanBtn")
        const camBtn = document.getElementById("cameraOnBtn")

        input.disabled = false
        scanBtn.disabled = false
        camBtn.disabled = false

        input.classList.remove("bg-gray-100")
        input.classList.add("bg-white")

        scanBtn.classList.remove("bg-gray-400")
        scanBtn.classList.add("bg-primary")

        camBtn.classList.remove("bg-gray-400")
        camBtn.classList.add("bg-primary")

      } catch (e) {
        showAlert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î")
      }
    }



    function renderSections() {

      const grid = document.getElementById("sectionGrid")
      const btn = document.getElementById("confirmReserveBtn")

      grid.innerHTML = ""

      const maxAllowed = getMaxSectionsAllowed()

      const sortedSections = [...availableSections]
        .sort((a, b) => a.start_seq - b.start_seq)

      const visibleSections = sortedSections
        .filter(s => s.end_seq <= showLimit)

      visibleSections.forEach(s => {

        const card = document.createElement("div")
        const isSelected = selectedSections.includes(s.id)
        const isLimitReached = selectedSections.length >= maxAllowed

        // ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì full ‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏ó‡∏ô
        const current = (s.current_seq ?? (s.start_seq - 1))
        const isFull = current >= s.end_seq

        let baseColor = ""
        let selectedColor = ""

        if (isFull) {
          baseColor = "bg-white text-gray-400 cursor-not-allowed border"
        }
        else if (s.status === "blocked") {
          baseColor = "bg-gray-200 text-gray-500 cursor-not-allowed"
        }
        else if (s.status === "mine") {
          baseColor = "bg-yellow-200 hover:bg-yellow-300"
          selectedColor = "bg-yellow-500 text-black"
        }
        else {
          baseColor = "bg-green-200 hover:bg-green-300"
          selectedColor = "bg-green-500 text-white"
        }

        card.className = `
          ${isSelected ? selectedColor : baseColor}
          rounded-xl
          shadow-sm
          transition
          duration-150
          p-2 md:p-4
          text-center
          text-xs md:text-base
          font-medium
          ${(!isFull && s.status !== "blocked") ? "cursor-pointer" : ""}
        `

        // üî• disable ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô limit
        if (!isSelected && isLimitReached) {
          card.classList.add("opacity-40", "pointer-events-none")
        }

        let remainText
        let remainClass = "text-500 font-semibold"

        if (isFull) {
          remainText = "‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ñ‡∏¥‡∏ß‡∏ß‡πà‡∏≤‡∏á"
        } else {
          const remainStart = current + 1
          remainText = `‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${remainStart}-${s.end_seq}`
        }

        card.innerHTML = `
          <div class="font-bold text-sm md:text-lg">
            ${s.start_seq}-${s.end_seq}
          </div>

          <div class="text-xs md:text-sm mt-1 ${remainClass}">
            ${remainText}
          </div>
        `

        // ‚úÖ ‡∏Å‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà full ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà blocked
        if (!isFull && (s.status === "available" || s.status === "mine")) {
          card.onclick = () => selectSection(s.id)
        }

        grid.appendChild(card)
      })

      // üî• ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
      if (sortedSections.some(s => s.end_seq > showLimit)) {

        const moreBtn = document.createElement("button")

        moreBtn.className = `
      col-span-3
      mt-3
      bg-primary/10
      text-primary
      py-2
      rounded-xl
      text-sm
      font-semibold
      hover:bg-primary/20
      transition
    `

        moreBtn.innerHTML = `
      <span class="material-symbols-outlined text-sm align-middle">expand_more</span>
      ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
    `

        moreBtn.onclick = () => {
          showLimit += 400   // ‡∏à‡∏≤‡∏Å 600 ‚Üí 1000
          renderSections()
        }

        grid.appendChild(moreBtn)
      }

      // üî• ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á (‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô 600 ‡πÅ‡∏•‡πâ‡∏ß)
      if (showLimit > 600) {

        const lessBtn = document.createElement("button")

        lessBtn.className = `
      col-span-3
      mt-2
      bg-gray-200
      text-gray-700
      py-2
      rounded-xl
      text-sm
      font-semibold
      hover:bg-gray-300
      transition
    `

        lessBtn.innerHTML = `
      <span class="material-symbols-outlined text-sm align-middle">expand_less</span>
      ‡πÅ‡∏™‡∏î‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á
    `

        lessBtn.onclick = () => {
          showLimit = 600
          renderSections()
        }

        grid.appendChild(lessBtn)
      }

      updateActionButton()
    }


    function updateActionButton() {

      const btn = document.getElementById("confirmReserveBtn")

      if (selectedSections.length === 0) {
        btn.classList.add("hidden")
        return
      }

      const hasMine = availableSections
        .filter(sec => selectedSections.includes(sec.id))
        .some(sec => sec.status === "mine")

      if (hasMine) {
        btn.className = "mt-4 w-full bg-red-500 text-white py-2 rounded-lg"
        btn.innerText = "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á"
        btn.onclick = cancelMultipleReservations
      } else {
        btn.className = "mt-4 w-full bg-primary text-white py-2 rounded-lg"
        btn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á"
        btn.onclick = confirmReservation
      }

      btn.classList.remove("hidden")
    }
    function cancelMultipleReservations() {

  if (!selectedSections.length) return

  const popup = document.getElementById("confirmPopup")

  // üî• ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏±‡∏ß
  document.getElementById("confirmTitle").innerText = "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á"

  document.getElementById("confirmMessage").innerText =
    "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà"

  const confirmBtn = popup.querySelector("button.bg-red-500")
  confirmBtn.innerText = "‡∏ï‡∏Å‡∏•‡∏á"

  confirmBtn.onclick = async () => {

    try {

      await fetch(`${SERVER}/api/queue/cancel`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          section_ids: selectedSections
        })
      })

      preview = preview.filter(p =>
        !selectedSections.includes(p.section_id)
      )

      save()
      render()

      showAlert("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success", "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")

      localStorage.removeItem("parcelAmount")
      localStorage.removeItem("selectedSections")
      localStorage.removeItem("reserveLocked")

      selectedSections = []
      reserveLocked = false

      updateActionButton()
      await loadAvailableSections()

    } catch (e) {
      showAlert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "error")
    }

    closeConfirm()
  }

  popup.classList.remove("hidden")
  popup.classList.add("flex")
}

    function getMaxSectionsAllowed() {

      const input = document.getElementById("parcelAmount")

      if (!input || !input.value) return 999

      const count = parseInt(input.value)
      return Math.max(1, Math.ceil(count / 50))
    }


    function selectSection(id) {

      const section = availableSections.find(s => s.id === id)
      if (!section) return

      // ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô mine = ‡∏Å‡∏î‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏à‡∏≠‡∏á
      if (section.status === "mine") {
        cancelReserve(id)
        return
      }

      // ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏à‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà
      if (reserveLocked) return

      const maxAllowed = getMaxSectionsAllowed()

      if (selectedSections.includes(id)) {
        selectedSections = selectedSections.filter(s => s !== id)
      } else {

        if (selectedSections.length >= maxAllowed) {
          showAlert(`‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ${maxAllowed} section`)
          return
        }

        selectedSections.push(id)
      }

      renderSections()
    }
    document.addEventListener("DOMContentLoaded", async () => {

      const savedAmount = localStorage.getItem("parcelAmount")
      const savedSections = localStorage.getItem("selectedSections")
      const locked = localStorage.getItem("reserveLocked")

      if (savedAmount) {
        document.getElementById("parcelAmount").value = savedAmount
      }

      if (savedSections) {
        selectedSections = JSON.parse(savedSections)
      }

      if (locked === "true") {
        reserveLocked = true
      }

      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ amount ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î section ‡πÉ‡∏´‡∏°‡πà
      if (savedAmount) {
        await loadAvailableSections()
      }

      renderSections()

      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏à‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏õ‡∏¥‡∏î scan ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏¢
      if (reserveLocked) {

        const input = document.getElementById("scanInput")
        const scanBtn = document.getElementById("scanBtn")
        const camBtn = document.getElementById("cameraOnBtn")

        input.disabled = false
        scanBtn.disabled = false
        camBtn.disabled = false

        input.classList.remove("bg-gray-100")
        input.classList.add("bg-white")

        scanBtn.classList.remove("bg-gray-400")
        scanBtn.classList.add("bg-primary")

        camBtn.classList.remove("bg-gray-400")
        camBtn.classList.add("bg-primary")
      }

    })
    function showAlert(message, type = "info", title = "‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô") {

      const popup = document.getElementById("alertPopup")
      const box = document.getElementById("alertBox")
      const icon = document.getElementById("alertIcon")

      document.getElementById("alertTitle").innerText = title
      document.getElementById("alertMessage").innerText = message

      // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
      if (type === "success") {
        icon.className = "mx-auto mb-3 w-14 h-14 flex items-center justify-center rounded-full text-white text-2xl bg-green-500"
        icon.innerHTML = "‚úì"
      }

      if (type === "error") {
        icon.className = "mx-auto mb-3 w-14 h-14 flex items-center justify-center rounded-full text-white text-2xl bg-red-500"
        icon.innerHTML = "‚úï"
      }

      if (type === "warning") {
        icon.className = "mx-auto mb-3 w-14 h-14 flex items-center justify-center rounded-full text-white text-2xl bg-yellow-500"
        icon.innerHTML = "!"
      }

      if (type === "info") {
        icon.className = "mx-auto mb-3 w-14 h-14 flex items-center justify-center rounded-full text-white text-2xl bg-primary"
        icon.innerHTML = "i"
      }

      popup.classList.remove("hidden")
      popup.classList.add("flex")

      setTimeout(() => {
        box.classList.remove("scale-95", "opacity-0")
        box.classList.add("scale-100", "opacity-100")
      }, 10)
    }

    function closeAlert() {
      const popup = document.getElementById("alertPopup")
      const box = document.getElementById("alertBox")

      box.classList.remove("scale-100", "opacity-100")
      box.classList.add("scale-95", "opacity-0")

      setTimeout(() => {
        popup.classList.add("hidden")
        popup.classList.remove("flex")
      }, 150)
    }
    function confirmAllCheck() {

  const message =
    "‡∏´‡∏≤‡∏Å‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏ä‡πâ section ‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ"

  document.getElementById("confirmTitle").innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î"
  document.getElementById("confirmMessage").innerText = message

  const popup = document.getElementById("confirmPopup")
  const confirmBtn = popup.querySelector("button.bg-red-500")

  // üî• reset ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô confirmAll
  confirmBtn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô"
  confirmBtn.onclick = confirmAll

  popup.classList.remove("hidden")
  popup.classList.add("flex")
}

    function closeConfirm() {
      const popup = document.getElementById("confirmPopup")
      popup.classList.add("hidden")
      popup.classList.remove("flex")
    }

    function showConfirmPopup(message, onConfirm) {

      const popup = document.getElementById("alertPopup")
      const box = document.getElementById("alertBox")
      const icon = document.getElementById("alertIcon")

      document.getElementById("alertTitle").innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î"
      document.getElementById("alertMessage").innerText = message

      icon.className = "mx-auto mb-3 w-14 h-14 flex items-center justify-center rounded-full text-white text-2xl bg-red-500"
      icon.innerHTML = "!"

      const btn = box.querySelector("button")

      btn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô"
      btn.onclick = () => {
        closeAlert()
        onConfirm()
      }

      popup.classList.remove("hidden")
      popup.classList.add("flex")

      setTimeout(() => {
        box.classList.remove("scale-95", "opacity-0")
        box.classList.add("scale-100", "opacity-100")
      }, 10)
    }



  </script>
  <!-- Queue Popup -->


</body>

</html>